# Sharon Test Environment - Path-Based Nginx Configuration
# Routes all services through single domain with path-based routing (HTTP for testing)

# Main HTTP server with path-based routing
server {
    listen 80;
    server_name _;  # Catch-all for any domain

    # General proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300;
    proxy_connect_timeout 300;

    # Large file uploads for dolores (video service)
    client_max_body_size 100M;

    # Health check endpoint (local nginx check)
    location /health {
        access_log off;
        return 200 "nginx healthy\n";
        add_header Content-Type text/plain;
    }

    # Service discovery endpoint
    location /services {
        proxy_pass http://allyabase:2999/services;
    }

    # Network info endpoint
    location /network/ {
        proxy_pass http://allyabase:2999/network/;
    }

    # Root endpoint
    location = / {
        proxy_pass http://allyabase:2999/;
    }

    # Core Planet Nine Services

    # BDO - Big Dumb Object Storage
    location /bdo/ {
        proxy_pass http://allyabase:3003/;
    }

    # Fount - MAGIC Protocol & Nineum
    location /fount/ {
        proxy_pass http://allyabase:3002/;
    }

    # Addie - Payment Processing
    location /addie/ {
        proxy_pass http://allyabase:3005/;
    }

    # Sanora - Product Hosting & Marketplace
    location /sanora/ {
        proxy_pass http://allyabase:7243/;
    }

    # Dolores - Social Feeds & Media
    location /dolores/ {
        proxy_pass http://allyabase:3007/;
    }

    # Covenant - Multi-party Contracts
    location /covenant/ {
        proxy_pass http://allyabase:3011/;
    }

    # Support Services

    # Pref - Preferences Storage
    location /pref/ {
        proxy_pass http://allyabase:3001/;
    }

    # ContinueBee - State Verification
    location /continuebee/ {
        proxy_pass http://allyabase:3000/;
    }

    # Joan - Account Recovery
    location /joan/ {
        proxy_pass http://allyabase:3004/;
    }

    # Julia - P2P Messaging & Key Coordination
    location /julia/ {
        proxy_pass http://allyabase:3006/;
    }

    # Minnie - Email Handling
    location /minnie/ {
        proxy_pass http://allyabase:3009/;
    }

    # Aretha - Limited-Run Products
    location /aretha/ {
        proxy_pass http://allyabase:3010/;
    }

    # Prof - Profile Management
    location /prof/ {
        proxy_pass http://allyabase:3008/;
    }

    # Default fallback for unmatched paths
    location / {
        return 404 '{"error": "Service not found", "available_services": ["/bdo/", "/fount/", "/julia/", "/addie/", "/sanora/", "/dolores/", "/covenant/", "/services", "/health"]}';
        add_header Content-Type application/json;
    }
}